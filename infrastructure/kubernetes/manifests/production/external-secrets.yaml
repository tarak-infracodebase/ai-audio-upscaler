# External Secrets Operator Configuration for AI Audio Upscaler
apiVersion: v1
kind: Namespace
metadata:
  name: external-secrets-system
---
# SecretStore for Azure Key Vault
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: azure-keyvault-store
  namespace: ai-audio-upscaler
spec:
  provider:
    azurekv:
      # Key Vault URL will be provided by Terraform output
      vaultUrl: "https://ai-upscaler-prod-kv-${random_suffix}.vault.azure.net/"
      authSecretRef:
        clientId:
          name: azure-secret-sp
          key: ClientID
        clientSecret:
          name: azure-secret-sp
          key: ClientSecret
      tenantId: "${tenant_id}"

---
# External Secret for Database Configuration
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: database-secrets
  namespace: ai-audio-upscaler
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-store
    kind: SecretStore
  target:
    name: database-secrets
    creationPolicy: Owner
  data:
    - secretKey: DATABASE_URL
      remoteRef:
        key: database-connection-string
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: postgres-admin-password

---
# External Secret for JWT Configuration
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jwt-secrets
  namespace: ai-audio-upscaler
spec:
  refreshInterval: 30m
  secretStoreRef:
    name: azure-keyvault-store
    kind: SecretStore
  target:
    name: jwt-secrets
    creationPolicy: Owner
  data:
    - secretKey: JWT_SECRET_KEY
      remoteRef:
        key: jwt-secret-key
    - secretKey: JWT_PRIVATE_KEY
      remoteRef:
        key: jwt-private-key
    - secretKey: JWT_PUBLIC_KEY
      remoteRef:
        key: jwt-public-key

---
# External Secret for Azure B2C Configuration
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: azure-b2c-secrets
  namespace: ai-audio-upscaler
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-store
    kind: SecretStore
  target:
    name: azure-b2c-secrets
    creationPolicy: Owner
  data:
    - secretKey: AZURE_B2C_CLIENT_SECRET
      remoteRef:
        key: azure-b2c-client-secret
    - secretKey: AZURE_B2C_CLIENT_ID
      remoteRef:
        key: azure-b2c-client-id
    - secretKey: AZURE_B2C_TENANT_NAME
      remoteRef:
        key: azure-b2c-tenant-name

---
# External Secret for Storage Configuration
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: storage-secrets
  namespace: ai-audio-upscaler
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-keyvault-store
    kind: SecretStore
  target:
    name: storage-secrets
    creationPolicy: Owner
  data:
    - secretKey: AZURE_STORAGE_CONNECTION_STRING
      remoteRef:
        key: storage-connection-string
    - secretKey: AZURE_STORAGE_ACCOUNT_KEY
      remoteRef:
        key: storage-account-key
    - secretKey: REDIS_CONNECTION_STRING
      remoteRef:
        key: redis-connection-string